<body>

<div data-section="accordion" id="content-nav">
  <section>
      <ul class="doc-sidebar" data-section-content data-section="accordion" id="content-sidebar"><section><a href="#" data-section-title>Classes</a><ul data-section-content data-section="accordion" ><section><a href="module_bufferStream_BufferStream" class="" data-section-title>BufferStream</a><ul class='methods' data-section-content data-section='accordion'><li data-type='method'><a href="module_bufferStream_BufferStream#_read">_read</a></li></ul><a href="module_bundler_Bundler" class="" data-section-title>Bundler</a><ul class='methods' data-section-content data-section='accordion'><li data-type='method'><a href="module_bundler_Bundler#bundle">bundle</a></li></ul></section></ul></section><section><a href="#" data-section-title>Modules</a><ul data-section-content data-section="accordion" ><section><a href="module_bufferStream" class="" data-section-title>bufferStream</a><a href="module_bundler" class="" data-section-title>bundler</a><a href="module_moov_bundler" class="" data-section-title>moov_bundler</a><ul class='methods' data-section-content data-section='accordion'><li data-type='method'><a href="module_moov_bundler#.bundle">bundle</a></li><li data-type='method'><a href="module_moov_bundler#.watch">watch</a></li></ul></section></ul></section></ul>
  </section>
</div>

<div id="main">
    
    <h1 class="page-title">bundler.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';
/**
 * @module bundler
 */
var fs = require('fs');
var path = require('path');
var browserify = require('browserify');
var bufferStream = require('./bufferStream.js');

var config = {
  version: require('../package.json').version
};

/**
 * File bundler.
 * @class
 */
function Bundler(opt) {
    this.scriptDir = opt.scriptDir;
    this.tmpDir = opt.tmpDir;
    this.entry = opt.entry;
    this.output = opt.output;
}

var AutoGeneratedComment = '' +
'/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *\n' +
' *  WARNING: Moovweb auto-generated file. Any changes you      *\n' +
' *  make here will be overwritten.                             *\n' +
' *                                                             *\n' +
' * Perhaps you were looking for index.js (the main entry point *\n' +
' * for Moovweb projects)?                                      *\n' +
' * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */\n';

function requireParentDep (dep) {
  var depPath = path.resolve(process.cwd(), 'node_modules', dep);
  return require(depPath);
}

/* validate required modules and versions for the moovweb platform */
function verifyDependencies (deps) {
  var requiredDeps = ['moov_rewriter', 'moov_stdlib'];
  // All major versions must match between requiredDeps and this module.
  var matchingMajorVersions = [];

  // Add moov_bundler version
  matchingMajorVersions.push(parseInt(config.version.split('.')[0]));

  // validate required modules and capture version
  requiredDeps.forEach(function(el, index, array) {
    if (deps.indexOf(el) === -1) {
      console.error('Required module "'+el+'" is missing. Please add it to package.json.\n');
      process.exit(1);
    }

    var depModule = requireParentDep(el);
    matchingMajorVersions.push(parseInt(depModule.version.split('.')[0]));
  });

  // Validate all Major versions match
  for (var i=1; i&lt;matchingMajorVersions.length; i++) {
    if (matchingMajorVersions[i-1] !== matchingMajorVersions[i]) {
      console.log('Version mismatch among required modules.\n' +
                  'The modules: moov_rewriter, moov_stdlib, and moov_bundler must\n' +
                  'all have the same Major version.  Please update your library\n' +
                  'versions to match.');
      process.exit(2);
    }
  }
}

function generateMoovConfig(config) {
  // verify config is object

  var data = 'module.exports = ' + JSON.stringify(config) + ';';
  return new bufferStream.BufferStream(new Buffer(data));
}

/**
 * File bundling process.
 * @param {Object} opt Options.
 */
Bundler.prototype.bundle = function (opt) {
  var packageJson = require(path.resolve(process.cwd(), 'package.json')),
      dependencies = Object.keys(packageJson &amp;&amp; packageJson.dependencies || {}),
      tmpOutput = path.join(this.tmpDir, this.output),
      absOutput = path.join(this.scriptDir, this.output),
      files = [];

  verifyDependencies(dependencies);

  function gatherJs(dir) {
    if (!fs.statSync(dir).isDirectory()) {
      return;
    }
    var dirs = fs.readdirSync(dir);
    for (var i = 0; i &lt; dirs.length; i++) {
      if (path.extname(dirs[i]) === '.js') {
        var abs = path.join(dir, dirs[i]);
        if (abs !== absOutput) {
          files.push(abs);
        }
      }
      else {
        gatherJs(path.join(dir, dirs[i]));
      }
    }
  }

  gatherJs(this.scriptDir);

  var b = browserify({
    debug: false,
    ignoreMissing: true,
    noParse: files
  });

  var cfg = generateMoovConfig(config);
  b.require(cfg, {expose: 'moov_config'});

  dependencies.forEach(function(dep){
    b.require(dep, {expose: dep});
  });

  for (var i = 0; i &lt; files.length; i++) {
    b.require(files[i], {expose: '/' + path.relative(this.scriptDir, files[i]).replace(/\\/g, '/')});
  }

  var rs = b.bundle();

  //create tmp if it doesn't already exist
  if (!fs.existsSync(this.tmpDir)){
    fs.mkdirSync(this.tmpDir);
  }
  var ws = fs.createWriteStream(tmpOutput);

  ws.write(AutoGeneratedComment);

  // This breaks if projects use ES6 stuff, but otherwise, minifies properly
  // var rs = b.require(dependencies)
  var self = this;
  ws.on('close', function(){
    // move tmp/output to scripts/output when done bundling
    if(fs.existsSync(tmpOutput)){
      console.log('Browserified ' + self.scriptDir + ' (' + self.entry + ') at ' + new Date());
      fs.renameSync(tmpOutput, absOutput, function(err){
        if(err) {
          console.log(err);
        }
      });
    }
  });
  rs.on('error', function(err) {
    console.log(err);
    ws.end('({output:"&lt;pre>JAVASCRIPT ERROR:"+' + JSON.stringify(err+'') + '+"&lt;/pre>"})');
  });
  rs.on('end', function() {
    ws.end();
  });
  rs.pipe(ws, { end: false });
};

module.exports = Bundler;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated at Tue Oct 13 2015 17:38:01 GMT-0700 (PDT)
</footer>

<script>prettyPrint();</script>
</body>
