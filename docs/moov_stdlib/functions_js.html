<body>

<div data-section="accordion" id="content-nav">
  <section>
      <ul class="doc-sidebar" data-section-content data-section="accordion" id="content-sidebar"><section><a href="#" data-section-title>Classes</a><ul data-section-content data-section="accordion" ><section><a href="module_headerset_HeaderSet" class="" data-section-title>HeaderSet</a><ul class='methods' data-section-content data-section='accordion'><li data-type='method'><a href="module_headerset_HeaderSet#addHeader">addHeader</a></li><li data-type='method'><a href="module_headerset_HeaderSet#header">header</a></li><li data-type='method'><a href="module_headerset_HeaderSet#removeAllHeaders">removeAllHeaders</a></li><li data-type='method'><a href="module_headerset_HeaderSet#removeHeader">removeHeader</a></li><li data-type='method'><a href="module_headerset_HeaderSet#toString">toString</a></li></ul></section></ul></section><section><a href="#" data-section-title>Modules</a><ul data-section-content data-section="accordion" ><section><a href="module_functions" class="" data-section-title>functions</a><ul class='methods' data-section-content data-section='accordion'><li data-type='method'><a href="module_functions#.absolutize">absolutize</a></li><li data-type='method'><a href="module_functions#.absolutizeSrcs">absolutizeSrcs</a></li><li data-type='method'><a href="module_functions#.activeLayers">activeLayers</a></li><li data-type='method'><a href="module_functions#.addAssets">addAssets</a></li><li data-type='method'><a href="module_functions#.addCanonicalTag">addCanonicalTag</a></li><li data-type='method'><a href="module_functions#.assert">assert</a></li><li data-type='method'><a href="module_functions#.asset">asset</a></li><li data-type='method'><a href="module_functions#.cleanMobileMetaTags">cleanMobileMetaTags</a></li><li data-type='method'><a href="module_functions#.getPageType">getPageType</a></li><li data-type='method'><a href="module_functions#.handleRobots">handleRobots</a></li><li data-type='method'><a href="module_functions#.insertDnsPrefetch">insertDnsPrefetch</a></li><li data-type='method'><a href="module_functions#.insertSubresource">insertSubresource</a></li><li data-type='method'><a href="module_functions#.isRobots">isRobots</a></li><li data-type='method'><a href="module_functions#.layer">layer</a></li><li data-type='method'><a href="module_functions#.layerNot">layerNot</a></li><li data-type='method'><a href="module_functions#.moveStylesAboveScripts">moveStylesAboveScripts</a></li><li data-type='method'><a href="module_functions#.moveStylesToHead">moveStylesToHead</a></li><li data-type='method'><a href="module_functions#.onDevelopment">onDevelopment</a></li><li data-type='method'><a href="module_functions#.perfectProxy">perfectProxy</a></li><li data-type='method'><a href="module_functions#.queryLayerText">queryLayerText</a></li><li data-type='method'><a href="module_functions#.relocateScripts">relocateScripts</a></li><li data-type='method'><a href="module_functions#.removeAllStyles">removeAllStyles</a></li><li data-type='method'><a href="module_functions#.removeDesktopJs">removeDesktopJs</a></li><li data-type='method'><a href="module_functions#.removeDesktopMobileIcon">removeDesktopMobileIcon</a></li><li data-type='method'><a href="module_functions#.removeHtmlComments">removeHtmlComments</a></li><li data-type='method'><a href="module_functions#.rewriteAspNetScripts">rewriteAspNetScripts</a></li><li data-type='method'><a href="module_functions#.rewriteJsSrcs">rewriteJsSrcs</a></li><li data-type='method'><a href="module_functions#.rewriteLink">rewriteLink</a></li><li data-type='method'><a href="module_functions#.rewriteLinks">rewriteLinks</a></li><li data-type='method'><a href="module_functions#.rewriteToProxy">rewriteToProxy</a></li><li data-type='method'><a href="module_functions#.sass">sass</a></li><li data-type='method'><a href="module_functions#.setPageType">setPageType</a></li><li data-type='method'><a href="module_functions#~gatherHosts">gatherHosts</a></li></ul></section><li><a href="module_headerset">headerset</a></li><li><a href="module_stdlib">stdlib</a></li></ul></section><section><a href="#" data-section-title>Namespaces</a><ul data-section-content data-section="accordion" ><section><a href="module_headerset_HeaderSet_fns" class="" data-section-title>fns</a><ul class='methods' data-section-content data-section='accordion'><li data-type='method'><a href="module_headerset_HeaderSet_fns#.addHeader">addHeader</a></li><li data-type='method'><a href="module_headerset_HeaderSet_fns#.header">header</a></li><li data-type='method'><a href="module_headerset_HeaderSet_fns#.method">method</a></li><li data-type='method'><a href="module_headerset_HeaderSet_fns#.method">method</a></li><li data-type='method'><a href="module_headerset_HeaderSet_fns#.path">path</a></li><li data-type='method'><a href="module_headerset_HeaderSet_fns#.path">path</a></li><li data-type='method'><a href="module_headerset_HeaderSet_fns#.removeAllHeaders">removeAllHeaders</a></li><li data-type='method'><a href="module_headerset_HeaderSet_fns#.removeHeader">removeHeader</a></li><li data-type='method'><a href="module_headerset_HeaderSet_fns#.statusCode">statusCode</a></li><li data-type='method'><a href="module_headerset_HeaderSet_fns#.statusCode">statusCode</a></li><li data-type='method'><a href="module_headerset_HeaderSet_fns#.statusText">statusText</a></li><li data-type='method'><a href="module_headerset_HeaderSet_fns#.statusText">statusText</a></li><li data-type='method'><a href="module_headerset_HeaderSet_fns#.versionMinor">versionMinor</a></li><li data-type='method'><a href="module_headerset_HeaderSet_fns#.versionMinor">versionMinor</a></li></ul></section><section><a href="module_stdlib_stdlib" class="" data-section-title>stdlib</a><ul class='methods' data-section-content data-section='accordion'><li data-type='method'><a href="module_stdlib_stdlib#.addCookie">addCookie</a></li><li data-type='method'><a href="module_stdlib_stdlib#.export">export</a></li><li data-type='method'><a href="module_stdlib_stdlib#.init$">init$</a></li><li data-type='method'><a href="module_stdlib_stdlib#.scoped$">scoped$</a></li></ul></section></ul></section><section><a href="#" data-section-title>Global</a><ul data-section-content data-section="accordion"><li><a href="global#breakpoint">breakpoint</a></li><li><a href="global#env">env</a></li><li><a href="global#layers">layers</a></li><li><a href="global#rules">rules</a></li><li><a href="global#tag">tag</a></li><li><a href="global#txt">txt</a></li></ul></section></ul>
  </section>
</div>

<div id="main">
    
    <h1 class="page-title">functions.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module functions
 */

/* globals $, body, env, head, html, layers, root, tag, txt, rules */

'use strict';
const url = require('url');
const path = require('path');
// The following can be used to manipulate a serialized dom object
// body, head, html are assigned when invoking stdlib.init$(selectorEngine, requestBody)

/**
 * @global
 * @param {string} name Tag type.
 * @param {Array.&lt;string>} attribs Attributes.
 * @param {string} content Content.
 * @returns {Object.&lt;string,Object>} Return a dictionary with type, name, attribs, children, next, prev and parent.
 */
global.tag = function(name, attribs, content) {
    let type = name === 'script' || name === 'style' ? name : 'tag';
    return {
        type: type,
        name: name,
        attribs: attribs || {},
        children: content ? [txt(content)] : [],
        next: null,
        prev: null,
        parent: null
    };
};

/**
 * @global
 * @param {string} content
 * @returns {Object.&lt;string,Object>} Return a dictionary with type, data, next, prev and parent. 
 */
global.txt = function(content) {
    return {
        data: content,
        type: 'text',
        next: null,
        prev: null,
        parent: null
    };
};

/**
 * @global
 * @param {string} breakpointId
 */
global.breakpoint = function(breakpointId) {
    if (global.debugEnabled) {
        console.log('Moov SDK breakpoint:', (breakpointId || ''));
        /*jshint -W087 */ // Allow debugger; statement
        debugger;
    }
};

/**
 * Get asset url.
 * @param {string} pathToFile Path to the asset file.
 * @returns {string} Return Asset url.
 */
exports.asset = function(pathToFile) {
    return url.resolve(url.format(env.asset_host), pathToFile);
};

/**
 * Inject a canonical link as long as there isn't already one.
 */
exports.addCanonicalTag = function() {
    // Inject a canonical link as long as there isn't already one.
    if (!head.find('link[rel="canonical"]')[0]) {
        head.append(
            tag('link', {rel: 'canonical', href: 'http://' + env.source_host + env.path})
        );
    }
    // Remove any alternate tags
    head.find('link[rel="alternate"]').remove();
};

/**
 * Rewrite host link to proxy.
 * @param {string} hostHH Host link.
 * @param {string} secure Secure prefix.
 * @param {string} catchAll
 * @returns {string} Return Rewritten link.
 */
exports.rewriteToProxy = function(hostHH, secure, catchAll) {
    var prefix = hostHH.match(/^(?:https?:)?\/\//);

    var missing = '';
    if (!prefix) {
        missing = secure ? 'https://' : 'http://';
    }
    else if (prefix[0] === '//') {
        missing = secure ? 'https:' : 'http:';
    }

    var key = missing + hostHH;
    var ctx_Rules = rules || [
        { Proxy: 'http://' + env.host,
            Upstream: 'http://' + env.source_host
        },
        { Proxy: 'https://' + env.host,
            Upstream: 'https://' + env.source_host
        },
        { Proxy: 'http://' + env.host,
            Upstream: 'http://' + env.source_host.replace(/^www\./, '')
        },
        { Proxy: 'https://' + env.host,
            Upstream: 'https://' + env.source_host.replace(/^www\./, '')
        }
    ];

    if (ctx_Rules[0]) {
        for (var i = 0; i &lt; ctx_Rules.length; i++) {
            var rr = ctx_Rules[i];
            if (rr.Direction !== 1 &amp;&amp; key === rr.Upstream) {
                var proxy = rr.Proxy;
                if (env.__catch_all_enabled__ === 'true') {
                    if(!proxy.match(catchAll)){
                        var proxy_url = url.parse(proxy);
                        proxy = proxy.replace(proxy_url.hostname, proxy_url.hostname + catchAll);
                    }
                }
                if (proxy.substring(0, missing.length) === missing) {
                    proxy = proxy.substring(missing.length);
                }
                return proxy;
            }
        }
    }
    return hostHH;
};

/**
 * Rewrite link to point to the correct domain.
 * @param {string} hostHH Host link.
 * @returns {string} Return Rewritten link.
 */
exports.rewriteLink = function(link) {
    if (/^mailto:/.test(link)) {
        return link;
    }
    return link.replace(/((?:(?:(?:http(?:s?)):)?(?:\/\/)?(?:(?:[a-zA-Z0-9][a-zA-Z0-9\-]*)(?:\.[\.a-zA-Z0-9\-]*)|localhost))(?:\:[0-9]+)?)/gi, function(hostHH) {
        var rewritten = exports.rewriteToProxy(hostHH, env.secure === 'true', env.__catch_all__);
        return rewritten;
    });
};

/**
 * Automatically rewrite links in html.js to modified links pointing to the correct domain.
 */
exports.rewriteLinks = function() {
    html.find('a, head base[href]').attr('href', function(_, attr) {
        return attr ? exports.rewriteLink(attr) : null;
    });
    html.find('form').attr('action', function(_, attr) {
        return attr ? exports.rewriteLink(attr) : null;
    });
};

exports.slashPath = function() {
    return env.path.replace(/[^\/]+$/, '').replace(/^$/, '/');
};

/**
 * Attempts to absolutize the scoped URL.
 * @param {string} link
 * @returns {string} Return absolute link.
 */
exports.absolutize = function(href) {
    if (/^(?![a-zA-Z]+:)(?!\/\/)(?!$)/.test(href)) {
        return '//' + env.source_host + (href[0] === '/' ? '' : exports.slashPath()) + href;
    }
    return href;
};

/**
 * Absolutize all srcs.
 */
exports.absolutizeSrcs = function() {
    html.find('img, script').attr('src', function(i, attr) {
        return attr ? exports.absolutize(attr) : null;
    });
};

/**
 * Rewrite all JavaScript srcs.
 */
exports.rewriteJsSrcs = function() {
    root.find('script').attr('src', function(i, attr) {
        return attr ? exports.rewriteLink(attr) : null;
    });
};

/**
 * Rewrite links and JavaScript srcs.
 */
exports.perfectProxy = function() {
    exports.rewriteLinks();
    exports.rewriteJsSrcs();
};

/**
 * Rewrite ASP.NET scripts.
 */
exports.rewriteAspNetScripts = function() {
    html.find('script[src*="ScriptResource.axd?"]').attr('src', function(_, attr) {
        return exports.rewriteLink(attr);
    });
};

/**
 * Remove all styles.
 */
exports.removeAllStyles = function() {
    html.find('link[rel="stylesheet"]:not([data-mw-keep]), style').remove();
};

/**
 * Clean mobile meta tags.
 */
exports.cleanMobileMetaTags = function() {
    head.append(
        tag('meta', {'http-equiv': 'Content-Type', content: 'text/html'}),
        tag('meta', {name: 'viewport', content: 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'}),
        tag('meta', {name: 'format-detection', content: 'telephone=no'})
    );
    head.find('meta[name="viewport"], meta[name="format-detection"]').remove();
};

/**
 * Remove desktop mobile icon.
 */
exports.removeDesktopMobileIcon = function() {
    head.find('link[rel="apple-touch-icon"], link[rel*="shortcut"][rel*="icon"]').remove();
};

/**
 * Remove html comments.
 */
exports.removeHtmlComments = function() {
    function helper(node) {
        var children = node.children;
        if (!children || !children[0]) {
            return;
        }
        for (var i = 0; i &lt; children.length; i++) {
            if (children[i].type === 'comment') {
                $(children[i]).remove();
            }
            else if (children[i].type === 'tag') {
                helper(children[i]);
            }
        }
    }
    helper(root[0]);
};

/**
 * Get sass file path
 * @param {string} baseName Filename.
 * @returns {string} Return url of the sass file
 */
exports.sass = function(baseName) {
    return exports.asset(path.join('stylesheets/.css/', baseName + '.css'));
};

/**
 * Add all assets.
 */
exports.addAssets = function() {
    // add the favicon and mobile stylesheet
    head.append(
        tag('link', {rel: 'shortcut icon', href: exports.asset('images/favicon.ico')}),
        tag('link', {rel: 'stylesheet', type: 'text/css', href: exports.sass('main'), 'data-mw-keep': 'true'})
    );

    // add mobile js
    var firstScript = head.children('script').first();
    if (firstScript[0]) {
        firstScript.before(
            tag('script', {'data-keep': 'true', type: 'text/javascript', src: exports.asset('javascript/main.js')})
        );
    }
    else {
        head.append(
            tag('script', {'data-keep': 'true', type: 'text/javascript', src: exports.asset('javascript/main.js')})
        );
    }
};

/**
 * Remove desktop JavaScript.
 */
exports.removeDesktopJs = function() {
    html.find('script[src]').each(function(/* i, elem */) {
        if (!($(this).attr('data-keep') || $(this).attr('data-keep') === 'false') &amp;&amp; !/ScriptResource\.axd/.test($(this).attr('src'))) {
            $(this).remove();
        }
    });
};

/**
 * Check robots.txt.
 * @returns {boolean} Return ture if robots.text is in the $PATH.
 */
exports.isRobots = function() {
    return (/\/robots\.txt/).test(env.path);
};

/**
 * Handle Robots.
 * @param {string} body
 * @returns {string} Return body.
 */
exports.handleRobots = function(body) {
    var isProd = /^(m\.|t\.)/;

    if (isProd.test(env.host)) {
        return body;
    }
    return 'User-agent: *\nDisallow: /';
};

/**
 * Append scripts to body.
 */
exports.relocateScripts = function() {
    body.append(html.find('script'));
};

//Layers

/**
 * Return a string value indicating whether or not the specified layer is active.
 * @param {string} layer
 * @returns {string} Return "1" if layer is active, "0" otherwise.
 */
exports.queryLayerText = function(layer) {
    return layers.indexOf(layer) >= 0 ? '1' : '0';
};


/**
 * Get active layers
 * @returns {Array.&lt;string>} Return layers.
 */
exports.activeLayers = function() {
    return layers;
};

/**
 * Return a boolean value indicating whether the specified layer is active.
 * @param {string} layer
 * @returns {boolean} Return true if layer is active, false otherwise.
 */
exports.layer = function(layer) {
    return exports.queryLayerText(layer) === '1';
};

/**
 * Return a boolean value indicating whether the specified layer is inactive.
 * @param {string} layer
 * @returns {boolean} Return true if layer is inactive, false otherwise.
 */
exports.layerNot = function(layer) {
    return exports.queryLayerText(layer) === '0';
};


/**
 * Check whether node_env is development.
 * @param {function} callback Callback function.
 * @returns {boolean} Return true if callback function is in development.
 */
exports.onDevelopment = function(callback){
    if (process.env.NODE_ENV === 'development'){
        if (typeof(callback) === 'function') {
            callback();
        }
        return true;
    }
    return false;
};

//Assert
/**
 * Make an assertion for conditional statement and run the callback if the statement is correct.
 * @param {boolean} conditional Conditional statement.
 * @param {function} callback Callback function
 * @returns {boolean} Return true if the statement is true.
 */
exports.assert = function(conditional, callback) {
    var failed = !conditional;
    exports.onDevelopment(function(){
        if (failed) {
            var error = new Error('Assert failed');
            throw error.stack;
        } else {
            if (typeof(callback) === 'function') {
                callback();
            }
        }
    });

    return !failed;
};


/**
 * Move styles above the html scripts.
 * @returns Return html after the changes.
 */
exports.moveStylesAboveScripts = function() {
    var styles = html.find('[rel~=stylesheet], style');
    return html.find('script').closest('script').first().before(styles);
};

/**
 * Prepend styles to head.
 * @returns Return head with styles.
 */
exports.moveStylesToHead = function() {
    var styles = html.find('[rel~=stylesheet], style');
    return head.prepend(styles);
};

/**
 * Insert subresource.
 * @param {Object} resource
 * @returns {Object} Return subresource.
 */
exports.insertSubresource = function(resource) {
    if (resource === undefined) {
        return undefined;
    }
    else {
        var subresource = tag('link', {rel: 'subresource', href: resource});
        head.append(subresource);
        return subresource;
    }
};

/**
 * Gather host based on slection and attribute.
 * @param {string} selection
 * @param {string} attribute
 * @param {Array.&lt;string>} hosts Original hosts array.
 * @returns {Array.&lt;string>} Return new hosts array.
 */
function gatherHosts(selection, attribute, hosts) {
    var host, hostSelector = /^((https?:)?\/\/.*?)(\/.*|$)/;
    if (hosts===undefined) {
        hosts = {};
    }
    html.find(selection).each(function() {
        if (hostSelector.test(this.attribs[attribute])) {
            host = hostSelector.exec(this.attribs[attribute]);
            if (host[1] !== undefined) {
                hosts[host[1]] = true;
            }
        }
    });
    return hosts;
}

/**
 * Insert DNS prefetch to head.
 */
exports.insertDnsPrefetch = function() {
    var domains = gatherHosts('img, script', 'src', {});
    gatherHosts('a, script', 'href', domains);

    for (var d in domains) {
        if (domains.hasOwnProperty(d)) {
            var prefetch = tag('link', {rel: 'dns-prefetch', href: d});
            head.append(prefetch);
        }
    }
};

/**
 * Set pagetype.
 * @param {string} type Pagetype.
 */
exports.setPageType = function(type) {
    if (typeof(type) === 'string' &amp;&amp; type.length &lt;= 256) {
        exports.export('pageType', type);
    } else {
        console.log('Invalid pageType: ' + type + '! It must be a string with a max length of 256.');
    }
};

/**
 * Get pagetype.
 * @returns {string} Return pagetype.
 */
exports.getPageType = function() {
    return env.pageType;
};

module.exports = exports;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated at Wed Oct 21 2015 00:17:45 GMT+0000 (UTC)
</footer>

<script>prettyPrint();</script>
</body>
