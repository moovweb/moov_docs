<body>

<div data-section="accordion" id="content-nav">
  <section>
      <ul class="doc-sidebar" data-section-content id="content-sidebar"><div data-section="accordion"><section class="active"><a href="#" class="module-one" data-section-title>Namespaces</a><ul data-section-content><div data-section='accordion'><section class='active'><a href="fns" class="" data-section-title>fns</a><ul class='methods' data-section-content><li data-type='method'><a href="fns#.absolutize">.absolutize()</a></li><li data-type='method'><a href="fns#.absolutizeSrcs">.absolutizeSrcs()</a></li><li data-type='method'><a href="fns#.activeLayers">.activeLayers()</a></li><li data-type='method'><a href="fns#.addAssets">.addAssets()</a></li><li data-type='method'><a href="fns#.addCanonicalTag">.addCanonicalTag()</a></li><li data-type='method'><a href="fns#.addCookie">.addCookie()</a></li><li data-type='method'><a href="fns#.assert">.assert()</a></li><li data-type='method'><a href="fns#.asset">.asset()</a></li><li data-type='method'><a href="fns#.cleanMobileMetaTags">.cleanMobileMetaTags()</a></li><li data-type='method'><a href="fns#.export">.export()</a></li><li data-type='method'><a href="fns#.getPageType">.getPageType()</a></li><li data-type='method'><a href="fns#.handleRobots">.handleRobots()</a></li><li data-type='method'><a href="fns#.highlightDevelopment">.highlightDevelopment()</a></li><li data-type='method'><a href="fns#.highlightPreview">.highlightPreview()</a></li><li data-type='method'><a href="fns#.init$">.init$()</a></li><li data-type='method'><a href="fns#.insertDnsPrefetch">.insertDnsPrefetch()</a></li><li data-type='method'><a href="fns#.insertSubresource">.insertSubresource()</a></li><li data-type='method'><a href="fns#.isRobots">.isRobots()</a></li><li data-type='method'><a href="fns#.layer">.layer()</a></li><li data-type='method'><a href="fns#.layerNot">.layerNot()</a></li><li data-type='method'><a href="fns#.moveStylesAboveScripts">.moveStylesAboveScripts()</a></li><li data-type='method'><a href="fns#.moveStylesToHead">.moveStylesToHead()</a></li><li data-type='method'><a href="fns#.onDevelopment">.onDevelopment()</a></li><li data-type='method'><a href="fns#.perfectProxy">.perfectProxy()</a></li><li data-type='method'><a href="fns#.queryLayerText">.queryLayerText()</a></li><li data-type='method'><a href="fns#.relocateScripts">.relocateScripts()</a></li><li data-type='method'><a href="fns#.removeAllStyles">.removeAllStyles()</a></li><li data-type='method'><a href="fns#.removeDesktopJs">.removeDesktopJs()</a></li><li data-type='method'><a href="fns#.removeDesktopMobileIcon">.removeDesktopMobileIcon()</a></li><li data-type='method'><a href="fns#.removeHtmlComments">.removeHtmlComments()</a></li><li data-type='method'><a href="fns#.rewriteAspNetScripts">.rewriteAspNetScripts()</a></li><li data-type='method'><a href="fns#.rewriteJsSrcs">.rewriteJsSrcs()</a></li><li data-type='method'><a href="fns#.rewriteLink">.rewriteLink()</a></li><li data-type='method'><a href="fns#.rewriteLinks">.rewriteLinks()</a></li><li data-type='method'><a href="fns#.rewriteToProxy">.rewriteToProxy()</a></li><li data-type='method'><a href="fns#.sass">.sass()</a></li><li data-type='method'><a href="fns#.scoped$">.scoped$()</a></li><li data-type='method'><a href="fns#.setPageType">.setPageType()</a></li><li data-type='method'><a href="fns#.slashPath">.slashPath()</a></li></ul></section></div><div data-section='accordion'><section class='active'><a href="headers" class="" data-section-title>headers</a><ul class='methods' data-section-content><li data-type='method'><a href="headers#.method">method</a></li><li data-type='method'><a href="headers#.path">path</a></li><li data-type='method'><a href="headers#.statusCode">statusCode</a></li><li data-type='method'><a href="headers#.statusText">statusText</a></li><li data-type='method'><a href="headers#.versionMinor">versionMinor</a></li><li data-type='method'><a href="headers#.addHeader">.addHeader()</a></li><li data-type='method'><a href="headers#.header">.header()</a></li><li data-type='method'><a href="headers#.removeAllHeaders">.removeAllHeaders()</a></li><li data-type='method'><a href="headers#.removeHeader">.removeHeader()</a></li></ul></section></div></ul></section></div><div data-section="accordion"><section class="active"><a href="#" class="module-one" data-section-title>Global</a><ul data-section-content><li><a href="global#breakpoint">breakpoint</a></li><li><a href="global#tag">tag</a></li><li><a href="global#txt">txt</a></li></ul></section></div></ul>
  </section>
</div>

<div id="main">
    
    <h1 class="page-title">stdlib.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* globals $this, cheerio, env, head, html, root, scoped$ */
/* exported PROXY_TO_UPSTREAM */

'use strict';

const PROXY_TO_UPSTREAM = 1;

module.exports = function(ctxObj) {
    // grabbing required keys from Hash (env, rules, and exports)
    global.env = ctxObj.env;
    global.rules = ctxObj.rules;
    global.layers = ctxObj.layers || [];
    global.project = ctxObj.project;
    if (ctxObj.env.node_env !== undefined) {
        process.env.NODE_ENV = ctxObj.env.node_env;
    }
    let exports = ctxObj.exports;
    // use env, rules, and exports to setup user VM context
    let stdlib = require('./functions.js');

    /**
     * @method export
     * @summary stdlib
     * @memberof fns
     * @description Sets custom environment variables. Certain environment
     * variables will correspond to actual response headers, including the
     * Location header (`Location`), the "Content-Type" header (`Content-Type`),
     * the "Content-Encoding" header (`compression`), and the cache time field
     * for the Cache-Control header (`Cache-Time`).
     * @param {String} key A string for the environment variable key.
     * @param {String} val A string for the environment variable value.
     * @return {undefined} `undefined`
     * @example
     * fns.export("Location", "http://www.google.com");
     * // => Result: Adds "Location": "http://www.google.com" to the `env` object
     * //    (and thus sends a redirect to Google).
     * @example
     * fns.export("Content-Type", "application/json");
     * // => Result: Adds "Content-Type": "application/json" to the `env` object.
     * @example
     * fns.export("compression", "gzip");
     * // => Result: Adds "Content-Encoding": "gzip" to the `env` object.
     * @example
     * fns.export("Cache-Time", "10");
     * // => Result: Adds "Cache-Time": "public, max-age=fake-cache-time" to the
     * //    `env` object.
     */
    stdlib.export = function(key, val) {
        exports.push([key, val]);
        env[key] = val;
    };

    /**
     * @method addCookie
     * @summary stdlib
     * @memberof fns
     * @description Adds a cookie while processing the current request.
     * @param {String} name A string for the name of the cookie.
     * @param {String} value A string for the value of the cookie.
     * @param {String} [domain] A string for the domain of the cookie.
     * @param {String} [path] A string for the path of the cookie.
     * @param {String} [expires] A string for the expiratoin date of the cookie.
     * @param {Boolean} [secure] A boolean for if the cookie should only be
     * transmitted via HTTPS.
     * @param {Boolean} [httpOnly] A boolean for if the cookie requires
     * protection against cross-site attacks.
     * @return {undefined} `undefined`
     * @example
     * fns.addCookie("favoriteDog", "joe", ".mysite.com");
     * // => Result: "favoriteDog" cookie added to the upstream domain
     * //    ".mysite.com", with a value of "joe"
     * @example
     * fns.addCookie("favoriteDog", "joe", ".mysite.com", "/mydir", "Thu, 01 Jan 2021 00:00:00 GMT", true, true);
     * // => Result: "favoriteDog" cookie added to the upstream domain
     * //    ".mysite.com", with a value of "joe", over the "/mydir" path, set
     * //    to expire at midnight GMT on January 1, 2021, only transmitted over
     * //    https, with protection against cross-site attacks.
     */
    stdlib.addCookie = function(name, value, domain, path, expires, secure, httpOnly) {
        let raw = name + '=' + value;
        if (domain) {
            raw += '; domain=' + domain;
        }
        if (path) {
            raw += '; path=' + path;
        }
        if (expires) {
            raw += '; expires=' + expires;
        }
        if (secure) {
            raw += '; secure';
        }
        if (httpOnly) {
            raw += '; httponly';
        }
        stdlib.export('__cookie__', env.__cookie__ + '\r\nSet-Cookie: ' + raw);
    };

    /**
     * @method scoped$
     * @summary stdlib
     * @memberof fns
     * @description Narrows down parts of the DOM you wish to use. `$this` is
     * implicitly redefined to the Cheerio object for `this`. Nesting `scoped$`
     * will maintain the current scope. When you reference a Cheerio object
     * outside the scope from within it supercedes the scope and can be used to
     * access DOM elements outside the current scope. For example, you can
     * access and modify specific elements outside the scope using
     * `$body.find()`. 
     * @param {Object} $ A Cheerio object to traverse down.
     * @returns {Object} A modified Cheerio reference given the original input
     * selector as the new "root."
     * @example
     * scoped$($body, function(){
     *     scoped$("script", function(){
     *         $this.attr("data-mw-keep", true);
     *     });
     * });
     * // => HTML input:
     * //    &lt;body>
     * //      &lt;script type="text/javascript" src="/script1.js">&lt;/script>
     * //    &lt;/body>
     * // => Returns: Cheerio object assocaited with the `body` element
     * // => HTML input:
     * //    &lt;body>
     * //      &lt;script type="text/javascript" src="/script1.js" data-mw-keep="true">&lt;/script>
     * //    &lt;/body>
     * @example
     * scoped$($body, function() {
     *   scoped$("script", function() {
     *     $this.attr("data-body", true);
     *   });
     *   $body.find("script").attr("data-global", true);
     * });
     * // => HTML input:
     * //    &lt;head>
     * //      &lt;script type="text/javascript" src="/script1.js">&lt;/script>
     * //    &lt;/head>
     * //    &lt;body>
     * //      &lt;script type="text/javascript" src="/script2.js">&lt;/script>
     * //    &lt;/body>
     * // => Returns: Cheerio object assocaited with the `body` element
     * // => HTML input:
     * //    &lt;head>
     * //      &lt;script type="text/javascript" src="/script1.js" data-global="true">&lt;/script>
     * //    &lt;/head>
     * //    &lt;body>
     * //      &lt;script type="text/javascript" src="/script2.js" data-body="true" data-global="true">&lt;/script>
     * //    &lt;/body>
     */
    stdlib.scoped$ = function($) {
        global.$child = function(sel, fn) {
            if (typeof sel === 'function') {
                fn = sel;
                sel = null;
            }
            return proxy($this.children(sel), fn);
        };

        var proxy = function(selector, context /* , root */ ) {
            if (typeof context !== 'function') {
                return $.apply(this, arguments);
            }
            var query = scoped$(selector);
            return query.each(function() {
                var $this = scoped$(this);

                var _$ = global.scoped$;
                var _$this = global.$this;

                // new nested $
                global.scoped$ = function(sel, fn) {
                    return proxy($(sel, query), fn);
                };
                global.$this = $this;

                var ret = context.call($this);
                global.scoped$ = _$;
                global.$this = _$this;
                return ret;
            });
        };

        proxy.$ = $; // keep original cheerio function
        Object.keys($).forEach(function(i) {
            proxy[i] = $[i];
        });
        return proxy;
    };

    /**
     * @method init$
     * @summary stdlib
     * @memberof fns
     * @description Initializes $ by loading a UTF-8 encoded string of an HTML
     * request into the Cheerio parsing library (generally, this would be the
     * global `body` variable - no `$` prefix). This also provides global
     * variables to efficiently query the DOM thereafter. These global variables
     * include the `$`, `$root`, `$html`, `$head`, and `$body` objects, which
     * allow you to create new Cheerio objects associated with specific DOM
     * traversals. This also provides access to the `scoped$` global function.
     * @param {String} body A string for the content document.
     * @param {Object} [opts] An object for parsing settings, taken from &lt;a
     * href="https://github.com/fb55/htmlparser2/wiki/Parser-options">htmlparser2&lt;/a>
     * and &lt;a href="https://github.com/fb55/DomHandler">DomHandler&lt;/a>.
     * @param {Boolean} [opts.xmlMode] A boolean for whether special elements
     * (`script` and `style`) should get special treatment and if "empty" tags
     * (eg. `br`) can have children. If false, the content of special tags will
     * be text only. For feeds and other XML content (documents that don't
     * consist of HTML), set this to true. Default: false.
     * @param {Boolean} [opts.decodeEntities] A boolean for whether entities
     * within the document will not be decoded. Defaults to true.
     * @param {Boolean} [opts.lowerCaseTags] A boolean for whether all tags
     * should be lowercased. If `xmlMode` is disabled, this defaults to true.
     * @param {Boolean} [opts.lowerCaseAttributeNames] A boolean for whether
     * attribute names should be lowercased. This has a noticeable impact on
     * speed, so it defaults to false.
     * @param {Boolean} [opts.recognizeCDATA] A boolean for whether CDATA
     * sections will be recognized as text even if the `xmlMode` option is not
     * enabled. Note: If `xmlMode` is set to true, then CDATA sections will
     * always be recognized as text.
     * @param {Boolean} [opts.recognizeSelfClosing] A boolean for whether
     * self-closing tags will trigger the `onclosetag` event even if xmlMode is
     * not set to true. Note: If `xmlMode` is set to true, then self-closing
     * tags will always be recognized.
     * @param {Boolean} [opts.normalizeWhitespace] A boolean for whether
     * whitespace in text nodes should be normalized (replaced by single
     * spaces). Default: false.
     * @param {Boolean} [opts.withDomLvl1] A boolean for whether DOM level
     * 1 properties should be added to all elements.
     * @param {Boolean} [opts.withStartIndices] A boolean for whether
     * a `startIndex` property will be added to nodes. When the parser is used
     * in a non-streaming fashion, `startIndex` is an integer indicating the
     * position of the start of the node in the document. Default: false.
     * @return {Object} An object containing property names that correspond to
     * the global variables set.
     * @example
     * fns.init$(body);
     * // => Returns: {
     * //      $: $,
     * //      scoped$: scoped$,
     * //      root: $root,
     * //      html: $html,
     * //      head: $head,
     * //      body: $body
     * //    }
     */
    stdlib.init$ = function(body, opts) {
        var $ = cheerio.load(body, opts);
        global.$root = $.root();
        global.$html = $root.children('html');
        global.$head = $html.children('head');
        global.$body = $html.children('body');
        global.scoped$ = stdlib.scoped$($);
        global.$ = $;
        return {
            $: $,
            scoped$: scoped$,
            root: $root,
            html: $html,
            head: $head,
            body: $body
        };
    };

    return stdlib;
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    <i>Last updated Wed Sep 28 2016 22:15:47 GMT+0000 (UTC)</i>
</footer>

<script>prettyPrint();</script>
</body>
